<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visiora Firestore Structure</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            color: #333;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background-color: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        h1, h2, h3 {
            color: #1a73e8;
        }
        h1 {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #eee;
            padding-bottom: 15px;
        }
        pre {
            background-color: #f0f0f0;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            font-family: 'Consolas', 'Monaco', monospace;
        }
        .db-structure {
            position: relative;
            margin: 30px 0;
            font-family: 'Consolas', 'Monaco', monospace;
        }
        .indent {
            margin-left: 30px;
        }
        .folder {
            color: #1a73e8;
            font-weight: bold;
        }
        .doc {
            color: #37474f;
        }
        .field {
            color: #4caf50;
        }
        .value {
            color: #f44336;
        }
        .code {
            background-color: #f5f5f5;
            padding: 20px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        .image {
            max-width: 100%;
            height: auto;
            display: block;
            margin: 30px auto;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }
        .note {
            background-color: #e8f4fd;
            padding: 15px;
            border-left: 4px solid #1a73e8;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Visiora Firestore Structure</h1>

        <div class="note">
            <p><strong>Important:</strong> This document explains the expected Firestore structure for the Visiora application, focusing on the nested collections for generated images.</p>
        </div>

        <h2>Overview</h2>
        <p>The Visiora application uses Firebase Firestore to store user data and generated images. The database structure follows a nested pattern to organize user-generated content.</p>

        <h2>Database Structure</h2>
        <div class="db-structure">
            <div class="folder">users (collection)</div>
            <div class="indent">
                <div class="doc">{uid} (document - User ID from Firebase Auth)</div>
                <div class="indent">
                    <div class="field">name:</div><span class="value">"Arjun Singh Kandari"</span><br>
                    <div class="field">email:</div><span class="value">"user@example.com"</span><br>
                    <div class="field">credits:</div><span class="value">10</span><br>
                    <div class="field">createdAt:</div><span class="value">timestamp</span><br>
                    <div class="field">lastLogin:</div><span class="value">timestamp</span><br>
                </div>
                <div class="folder">GeneratedImages (subcollection)</div>
                <div class="indent">
                    <div class="doc">{containerId} (document - auto-generated)</div>
                    <div class="indent">
                        <div class="field">createdAt:</div><span class="value">timestamp</span><br>
                    </div>
                    <div class="folder">img1 (subcollection)</div>
                    <div class="indent">
                        <div class="doc">{imageId} (document - auto-generated)</div>
                        <div class="indent">
                            <div class="field">prompt:</div><span class="value">"Beautiful mountain landscape"</span><br>
                            <div class="field">imageURL:</div><span class="value">"https://..."</span><br>
                            <div class="field">width:</div><span class="value">1080</span><br>
                            <div class="field">height:</div><span class="value">720</span><br>
                            <div class="field">modelUsed:</div><span class="value">"flux"</span><br>
                            <div class="field">createdAt:</div><span class="value">timestamp</span><br>
                        </div>
                    </div>
                    <div class="folder">img2 (subcollection - optional)</div>
                    <div class="indent">
                        <div class="doc">{imageId} (document - auto-generated)</div>
                        <div class="indent">
                            <div class="field">prompt:</div><span class="value">"Beautiful mountain landscape variation"</span><br>
                            <div class="field">imageURL:</div><span class="value">"https://..."</span><br>
                            <div class="field">width:</div><span class="value">1080</span><br>
                            <div class="field">height:</div><span class="value">720</span><br>
                            <div class="field">modelUsed:</div><span class="value">"flux"</span><br>
                            <div class="field">createdAt:</div><span class="value">timestamp</span><br>
                        </div>
                    </div>
                </div>
                <div class="doc">... additional container documents ...</div>
            </div>
        </div>

        <h2>Important Structural Points</h2>
        <ul>
            <li><strong>User Document ID:</strong> Must be the UID from Firebase Authentication</li>
            <li><strong>GeneratedImages:</strong> A subcollection of a user document</li>
            <li><strong>Container Documents:</strong> Auto-generated IDs, each container can hold multiple related images</li>
            <li><strong>Image Collections:</strong> Named img1, img2, etc., each holds a single image document</li>
            <li><strong>Image Document:</strong> Contains metadata and URL for the actual image</li>
        </ul>

        <h2>Code Implementation</h2>
        <p>The application implements this structure in the following services:</p>
        
        <h3>Creating a User (userService.js)</h3>
        <pre>
// Create user document with UID as document ID
const userRef = doc(db, 'users', user.uid);
await setDoc(userRef, {
  name: user.displayName || 'User',
  email: user.email || 'anonymous@user.com',
  credits: 10,
  createdAt: serverTimestamp(),
  lastLogin: serverTimestamp()
});
        </pre>

        <h3>Saving an Image (imageService.js)</h3>
        <pre>
// 1. Create the container document
const generatedImagesRef = collection(db, 'users', uid, 'GeneratedImages');
const containerDocRef = await addDoc(generatedImagesRef, {
  createdAt: serverTimestamp()
});
const containerId = containerDocRef.id;

// 2. Create the img1 subcollection and add the image data
const imgCollectionRef = collection(db, 'users', uid, 'GeneratedImages', containerId, 'img1');
const imageDoc = {
  prompt: "Mountain landscape",
  imageURL: "https://...",
  width: 1080,
  height: 720,
  modelUsed: "flux",
  createdAt: serverTimestamp()
};
const actualImageDocRef = await addDoc(imgCollectionRef, imageDoc);
        </pre>

        <h2>How to Verify Structure</h2>
        <p>To verify this structure is working correctly:</p>
        <ol>
            <li>Sign in to the application with your Google account</li>
            <li>Open your browser's developer console</li>
            <li>Run: <code>validateCurrentUserStructure()</code></li>
        </ol>
        <p>This will check if your user document exists with the correct structure and print the results in the console.</p>

        <div class="note">
            <p><strong>Note:</strong> If your user document doesn't exist or has an incorrect structure, you can run <code>createUserDocument()</code> in the console to create it.</p>
        </div>

        <h2>Security Rules</h2>
        <p>The Firestore security rules are configured to allow users to read and write only their own data:</p>
        <pre>
match /users/{userId} {
  // Allow users to read and write their own documents
  allow read, write: if request.auth.uid == userId;
  
  // Allow nested collections under user document
  match /GeneratedImages/{containerId} {
    allow read, write: if request.auth.uid == userId;
    
    // Allow deeply nested collections
    match /{collection}/{docId} {
      allow read, write: if request.auth.uid == userId;
    }
  }
}
        </pre>
    </div>
</body>
</html>
